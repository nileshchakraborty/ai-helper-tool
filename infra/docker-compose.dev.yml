

services:
  backend:
    build:
      context: ../backend
      dockerfile: Dockerfile
    env_file:
      - ../.env
    environment:
      - NODE_ENV=development
      - PORT=3000
      - DATABASE_URL=postgresql://dev:dev@postgres:5432/maccopilot
      - REDIS_URL=redis://redis:6379
      # API Keys should be passed from host env or .env file
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - OLLAMA_HOST=http://ollama:11434
      - OLLAMA_MODEL=${OLLAMA_MODEL:-qwen2.5-coder:14b}
      - OLLAMA_API_KEY=${OLLAMA_API_KEY:-}
      # MLX runs on host machine (localhost:8189), not in Docker
      # Use host.docker.internal on Mac to access host services
      - MLX_IMAGE_HOST=http://host.docker.internal:8189
    ports:
      - "3000:3000"
    depends_on:
      - postgres
      - redis
      - ollama
    command: npm start
    # Allow access to host network for MLX service
    extra_hosts:
      - "host.docker.internal:host-gateway"

  ollama:
    image: ollama/ollama:latest
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama

  postgres:
    image: postgres:15-alpine
    restart: always
    environment:
      POSTGRES_USER: dev
      POSTGRES_PASSWORD: dev
      POSTGRES_DB: maccopilot
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    restart: always
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  # Vector Store for RAG
  chromadb:
    image: chromadb/chroma:latest
    ports:
      - "8000:8000"
    volumes:
      - chroma_data:/chroma/chroma
    environment:
      - ANONYMIZED_TELEMETRY=false

  # Knowledge Graph for relationships
  neo4j:
    image: neo4j:5-community
    ports:
      - "7474:7474" # Browser UI
      - "7687:7687" # Bolt protocol
    environment:
      - NEO4J_AUTH=neo4j/interview123
    volumes:
      - neo4j_data:/data

volumes:
  postgres_data:
  redis_data:
  ollama_data:
  chroma_data:
  neo4j_data:
